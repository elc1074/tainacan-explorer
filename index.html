<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tainacan Masonry Gallery</title>
<style>
  :root {
    --gap: 12px;
    --bg: #0b0b0c;
    --tile-bg: #111;
    --radius: 14px;
  }
  html, body {
    margin: 0; padding: 0; background: var(--bg); color: #e8e8ea;
    font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial;
  }
  header { padding: 16px 14px 0; }
  header h1 { margin: 0 0 6px; font-size: 18px; font-weight: 600; }
  header .meta { opacity: .7; font-size: 12px; }
  .masonry {
    column-gap: var(--gap);
    padding: 14px;
  }
  @media (min-width: 380px) { .masonry { column-count: 2; } }
  @media (min-width: 640px) { .masonry { column-count: 3; } }
  @media (min-width: 920px) { .masonry { column-count: 4; } }
  @media (min-width: 1200px){ .masonry { column-count: 5; } }
  .tile {
    break-inside: avoid;
    margin: 0 0 var(--gap);
    background: var(--tile-bg);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
    transform: translateZ(0);
    opacity: 0; translate: 0 8px;
    transition: opacity .4s ease, translate .4s ease, box-shadow .2s ease;
  }
  .tile.visible { opacity: 1; translate: 0 0; }
  .tile a { display:block; text-decoration:none; color:inherit; }
  .tile img { display:block; width:100%; height:auto; background:#000; }
  .caption {
    padding: 8px 10px;
    font-size: 12px;
    color: #cfcfd4;
    border-top: 1px solid rgba(255,255,255,.06);
  }
  .tile:hover { box-shadow: 0 10px 28px rgba(0,0,0,.5); }
  .loader { margin: 24px auto 40px; width: 52px; display: grid; grid-auto-flow: column; gap: 8px; }
  .loader span {
    width: 10px; height: 10px; border-radius: 50%; background: #8e8ea0; opacity:.4;
    animation: pulse 1.1s infinite ease-in-out;
  }
  .loader span:nth-child(2){ animation-delay: .15s }
  .loader span:nth-child(3){ animation-delay: .30s }
  @keyframes pulse { 0%,100%{opacity:.2} 50%{opacity:1} }
  .hidden { display:none }
</style>
</head>
<body>
  <header>
    <h1>Mosaico — Acervo Artístico (UFSM)</h1>
    <div class="meta" id="meta">Carregando…</div>
  </header>

  <main class="masonry" id="masonry"></main>

  <div class="loader" id="loader"><span></span><span></span><span></span></div>

<script>
const BASE = 'https://tainacan.ufsm.br/acervo-artistico/wp-json/tainacan/v2/collection/2174/items';
const PER_PAGE = 100;
const FIELDS = 'id,title,document,thumbnail,url';
const masonry = document.getElementById('masonry');
const meta = document.getElementById('meta');
const loader = document.getElementById('loader');

function pickSmallThumb(thumbnail) {
  // Handles object of sizeName -> [url, w, h, cropped?, blurhash]
  if (!thumbnail) return null;
  if (Array.isArray(thumbnail)) {
    const withArea = thumbnail.map(o => ({...o, _area:(+o.width||0)*(+o.height||0)}));
    withArea.sort((a,b)=>(a._area||Infinity)-(b._area||Infinity));
    return withArea[0]?.src || null;
  }
  if (typeof thumbnail === 'object') {
    const entries = Object.entries(thumbnail)
      .filter(([k,v]) => Array.isArray(v) && v.length >= 3);
    if (entries.length) {
      // Prefer explicit tiny sizes if present
      const pref = ['tainacan-small','thumbnail','tainacan-medium','medium'];
      for (const name of pref) {
        const hit = entries.find(([k]) => k === name);
        if (hit) return hit[1][0];
      }
      // Otherwise, choose by smallest width
      entries.sort((a,b) => (a[1][1]||Infinity) - (b[1][1]||Infinity));
      return entries[0][1][0];
    }
    if (thumbnail.src) return thumbnail.src;
  }
  if (typeof thumbnail === 'string') return thumbnail;
  return null;
}

function pickDocUrl(doc, fallback, pageUrl) {
  // Prefer the public item page when available
  if (pageUrl) return pageUrl;
  if (!doc) return fallback || null;
  return doc.url || doc.src || doc.file || (typeof doc === 'string' ? doc : fallback || null);
}

function buildSrcSet(thumbnail) {
  if (!thumbnail || typeof thumbnail !== 'object') return null;
  const entries = Object.entries(thumbnail)
    .filter(([k,v]) => Array.isArray(v) && v.length >= 3)
    .map(([k,v]) => ({ url: v[0], w: +v[1] || null }))
    .filter(o => o.url && o.w);
  if (!entries.length) return null;
  entries.sort((a,b)=>a.w-b.w);
  return entries.map(o => `${o.url} ${o.w}w`).join(', ');
}



function pickAlt(thumbnailAlt, title, id){
  return (thumbnailAlt && thumbnailAlt.trim()) || title || `Item ${id}`;
}

function makeTile({id, title, thumbUrl, docUrl, thumbSrcSet, thumbnailAlt}) {
  const figure = document.createElement('figure');
  figure.className = 'tile';
  const link = document.createElement('a');
  link.href = docUrl || thumbUrl || '#';
  link.target = '_blank';
  const img = document.createElement('img');
  img.loading = 'lazy'; img.decoding = 'async';
  img.alt = pickAlt(thumbnailAlt, title, id);
  if (thumbSrcSet) img.srcset = thumbSrcSet;
  img.sizes = '(max-width: 639px) 45vw, (max-width: 919px) 30vw, (max-width: 1199px) 22vw, 18vw';
  img.src = thumbUrl || docUrl || '';
  link.appendChild(img);
  const cap = document.createElement('figcaption');
  cap.className = 'caption'; cap.textContent = title || `Item ${id}`;
  figure.append(link, cap);
  return figure;
}




const revealer = new IntersectionObserver(entries => {
  entries.forEach(e => {
    if (e.isIntersecting) { e.target.classList.add('visible'); revealer.unobserve(e.target); }
  });
}, {rootMargin: '60px'});

async function fetchPage(page=1) {
  const url = `${BASE}?perpage=${PER_PAGE}&paged=${page}&fetch_only=${encodeURIComponent(FIELDS)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

(async () => {
  try {
    let page = 1, count = 0;
    while (true) {
      const response = await fetchPage(page);
      const items = response.items;
      
      if (!Array.isArray(items) || items.length === 0) {
        break;
      }
      
      const fieldName = 'medium';
      const normalized = items.map(it => {
        const t = it.thumbnail;
        const medium = (t && typeof t === 'object' && Array.isArray(t[fieldName]))
          ? t[fieldName][0]   // [url, width, height, cropped?, blurhash]
          : null;

        const thumbUrl = medium;
        const docUrl = pickDocUrl(it.document, thumbUrl, it.url);

        return { id: it.id, title: it.title, thumbUrl, docUrl, thumbnailAlt: it.thumbnail_alt };
      }).filter(x => x.thumbUrl || x.docUrl);

      // const normalized = items.map(it => {
      //   const thumbUrl = pickSmallThumb(it.thumbnail);
      //   const docUrl = pickDocUrl(it.document, thumbUrl, it.url);
      //   const thumbSrcSet = buildSrcSet(it.thumbnail);
      //   return { id: it.id, title: it.title, thumbUrl, docUrl, thumbSrcSet, thumbnailAlt: it.thumbnail_alt };
      // }).filter(x => x.thumbUrl || x.docUrl);
      const frag = document.createDocumentFragment();
      normalized.forEach(info => {
        const tile = makeTile(info);
        frag.appendChild(tile);
      });
      masonry.appendChild(frag);
      normalized.forEach((_, idx) => revealer.observe(masonry.children[count+idx]));
      count += normalized.length;
      if (items.length < PER_PAGE) break;
      page++;
    }
    loader.classList.add('hidden');
    meta.textContent = `${count} itens carregados.`;
  } catch (err) {
    loader.classList.add('hidden');
    console.error(err);
    meta.textContent = 'Erro ao carregar a galeria.';
  }
})();
</script>
</body>
</html>
